{%- comment -%}
Auto-link system that creates links for videos, articles, and people names
while avoiding double-linking (replacing text that's already inside links)

This system processes content in four phases:
0. Hidden People Links - Converts explicit links to hidden people into [REDACTED]
1. Videos - Links video titles to their pages
2. Articles - Links article titles to their pages (including embedded content)
3. People - Links person names to their pages, with conflict detection

The people processing phase includes conflict detection to prevent double-linking.
When a person's name appears within an article title that has already been linked,
the person name linking is skipped. For example:
- Article "Taylor Gerring Photos" gets linked first
- When processing people, "Taylor Gerring" is detected as already being
  part of an existing article link, so it's skipped
- This prevents creating nested <a> tags like:
  <a href="/articles/taylor-gerring-photos/"><a href="/people/taylor-gerring/">Taylor Gerring</a> Photos</a>

The system maintains proper priority: Hidden People > Videos > Articles > People
while ensuring clean, valid HTML output.
{%- endcomment -%}

{%- assign body_content = include.content -%}

{%- comment -%}Protect content inside no-auto-link-marker spans{%- endcomment -%}
{%- assign protected_spans = "" | split: "" -%}
{%- assign span_parts = body_content | split: '<span class="no-auto-link-marker">' -%}
{%- if span_parts.size > 1 -%}
  {%- assign new_body = span_parts[0] -%}
  {%- for part in span_parts offset: 1 -%}
    {%- assign end_parts = part | split: '</span>' -%}
    {%- if end_parts.size > 1 -%}
      {%- assign placeholder = '___PROTECTED_SPAN_' | append: forloop.index | append: '___' -%}
      {%- assign original_content = '<span class="no-auto-link-marker">' | append: end_parts[0] | append: '</span>' -%}
      {%- assign span_pair = placeholder | append: '|||' | append: original_content -%}
      {%- assign protected_spans = protected_spans | push: span_pair -%}
      {%- assign new_body = new_body | append: placeholder -%}
      {%- for remaining in end_parts offset: 1 -%}
        {%- if forloop.first -%}
          {%- assign new_body = new_body | append: remaining -%}
        {%- else -%}
          {%- assign new_body = new_body | append: '</span>' | append: remaining -%}
        {%- endif -%}
      {%- endfor -%}
    {%- else -%}
      {%- assign new_body = new_body | append: '<span class="no-auto-link-marker">' | append: part -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign body_content = new_body -%}
{%- endif -%}

{%- comment -%}Process hidden content links first - replace explicit links to hidden people and articles with [REDACTED]{%- endcomment -%}

{%- comment -%}Handle hidden articles{%- endcomment -%}
{%- for article in site.articles -%}
  {%- if article.hidden -%}
    {%- assign article_url_pattern = article.url | append: '"' -%}
    {%- assign article_url_pattern_slash = article.url | append: '/"' -%}
    
    {%- assign parts = body_content | split: '<a href="' -%}
    {%- assign new_content = "" -%}
    {%- for part in parts -%}
      {%- if forloop.first -%}
        {%- assign new_content = part -%}
      {%- else -%}
        {%- if part contains article_url_pattern or part contains article_url_pattern_slash -%}
          {%- assign close_tag_parts = part | split: '</a>' -%}
          {%- if close_tag_parts.size > 1 -%}
            {%- assign link_start = close_tag_parts[0] -%}
            {%- if link_start contains article.url -%}
              {%- assign new_content = new_content | append: '[REDACTED]' -%}
              {%- for remaining_part in close_tag_parts offset: 1 -%}
                {%- if forloop.first -%}
                  {%- assign new_content = new_content | append: remaining_part -%}
                {%- else -%}
                  {%- assign new_content = new_content | append: '</a>' | append: remaining_part -%}
                {%- endif -%}
              {%- endfor -%}
            {%- else -%}
              {%- assign new_content = new_content | append: '<a href="' | append: part -%}
            {%- endif -%}
          {%- else -%}
            {%- assign new_content = new_content | append: '<a href="' | append: part -%}
          {%- endif -%}
        {%- else -%}
          {%- assign new_content = new_content | append: '<a href="' | append: part -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign body_content = new_content -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%}Handle hidden people{%- endcomment -%}
{%- for person in site.people -%}
  {%- if person.hidden -%}
    {%- comment -%}Handle links with various formats - we need to replace the entire <a>...</a> tag{%- endcomment -%}
    {%- assign person_url_pattern = person.url | append: '"' -%}
    {%- assign person_url_pattern_slash = person.url | append: '/"' -%}
    
    {%- comment -%}Split content on opening link tag to find matches{%- endcomment -%}
    {%- assign parts = body_content | split: '<a href="' -%}
    {%- assign new_content = "" -%}
    {%- for part in parts -%}
      {%- if forloop.first -%}
        {%- assign new_content = part -%}
      {%- else -%}
        {%- comment -%}Check if this part starts with the hidden person's URL{%- endcomment -%}
        {%- if part contains person_url_pattern or part contains person_url_pattern_slash -%}
          {%- comment -%}Find the closing tag and replace the link with [REDACTED]{%- endcomment -%}
          {%- assign close_tag_parts = part | split: '</a>' -%}
          {%- if close_tag_parts.size > 1 -%}
            {%- comment -%}Check if this is actually a link to this person{%- endcomment -%}
            {%- assign link_start = close_tag_parts[0] -%}
            {%- if link_start contains person.url -%}
              {%- assign new_content = new_content | append: '[REDACTED]' -%}
              {%- for remaining_part in close_tag_parts offset: 1 -%}
                {%- if forloop.first -%}
                  {%- assign new_content = new_content | append: remaining_part -%}
                {%- else -%}
                  {%- assign new_content = new_content | append: '</a>' | append: remaining_part -%}
                {%- endif -%}
              {%- endfor -%}
            {%- else -%}
              {%- assign new_content = new_content | append: '<a href="' | append: part -%}
            {%- endif -%}
          {%- else -%}
            {%- assign new_content = new_content | append: '<a href="' | append: part -%}
          {%- endif -%}
        {%- else -%}
          {%- assign new_content = new_content | append: '<a href="' | append: part -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign body_content = new_content -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%}Protect HTML attributes AFTER hidden people processing but BEFORE name replacements{%- endcomment -%}
{%- assign protected_attributes = "" | split: "" -%}
{%- assign attr_counter = 0 -%}
{%- assign attribute_names = "alt|title|aria-label|aria-describedby|data-|src" | split: "|" -%}

{%- for attr_name in attribute_names -%}
  {%- comment -%}Match attributes like: alt="text" or title='text'{%- endcomment -%}
  {%- assign attr_pattern_double = attr_name | append: '="' -%}
  {%- assign attr_pattern_single = attr_name | append: "='" -%}
  
  {%- comment -%}Process double-quoted attributes{%- endcomment -%}
  {%- assign attr_parts = body_content | split: attr_pattern_double -%}
  {%- if attr_parts.size > 1 -%}
    {%- assign new_body = attr_parts[0] -%}
    {%- for part in attr_parts offset: 1 -%}
      {%- assign quote_parts = part | split: '"' -%}
      {%- if quote_parts.size > 1 -%}
        {%- assign attr_value = quote_parts[0] -%}
        {%- assign placeholder = '___PROTECTED_ATTR_' | append: attr_counter | append: '___' -%}
        {%- assign original_attr = attr_pattern_double | append: attr_value | append: '"' -%}
        {%- assign attr_pair = placeholder | append: '|||' | append: original_attr -%}
        {%- assign protected_attributes = protected_attributes | push: attr_pair -%}
        {%- assign new_body = new_body | append: placeholder -%}
        {%- assign attr_counter = attr_counter | plus: 1 -%}
        {%- for remaining in quote_parts offset: 1 -%}
          {%- if forloop.first -%}
            {%- assign new_body = new_body | append: remaining -%}
          {%- else -%}
            {%- assign new_body = new_body | append: '"' | append: remaining -%}
          {%- endif -%}
        {%- endfor -%}
      {%- else -%}
        {%- assign new_body = new_body | append: attr_pattern_double | append: part -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign body_content = new_body -%}
  {%- endif -%}
  
  {%- comment -%}Process single-quoted attributes{%- endcomment -%}
  {%- assign attr_parts = body_content | split: attr_pattern_single -%}
  {%- if attr_parts.size > 1 -%}
    {%- assign new_body = attr_parts[0] -%}
    {%- for part in attr_parts offset: 1 -%}
      {%- assign quote_parts = part | split: "'" -%}
      {%- if quote_parts.size > 1 -%}
        {%- assign attr_value = quote_parts[0] -%}
        {%- assign placeholder = '___PROTECTED_ATTR_' | append: attr_counter | append: '___' -%}
        {%- assign original_attr = attr_pattern_single | append: attr_value | append: "'" -%}
        {%- assign attr_pair = placeholder | append: '|||' | append: original_attr -%}
        {%- assign protected_attributes = protected_attributes | push: attr_pair -%}
        {%- assign new_body = new_body | append: placeholder -%}
        {%- assign attr_counter = attr_counter | plus: 1 -%}
        {%- for remaining in quote_parts offset: 1 -%}
          {%- if forloop.first -%}
            {%- assign new_body = new_body | append: remaining -%}
          {%- else -%}
            {%- assign new_body = new_body | append: "'" | append: remaining -%}
          {%- endif -%}
        {%- endfor -%}
      {%- else -%}
        {%- assign new_body = new_body | append: attr_pattern_single | append: part -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign body_content = new_body -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%}Process videos first{%- endcomment -%}
{%- for video in site.videos -%}
  {%- assign title_to_replace = video.title -%}
  {%- assign link_replacement = '<a href="' | append: video.url | append: '">' | append: video.title | append: '</a>' -%}
  {%- assign body_content = body_content | replace: title_to_replace, link_replacement -%}
{%- endfor -%}

{%- comment -%}Process articles second - always create simple links, never embeds{%- endcomment -%}
{%- for article in site.articles -%}
  {%- assign title_to_replace = article.title -%}
  {%- assign alias_to_replace = article.alias -%}
  {%- assign link_replacement = '<a href="' | append: article.url | append: '">' | append: article.title | append: '</a>' -%}
  {%- assign body_content = body_content | replace: title_to_replace, link_replacement -%}
  {%- if alias_to_replace %}
    {%- assign alias_link_replacement = '<a href="' | append: article.url | append: '">' | append: article.alias | append: '</a>' -%}
    {%- assign body_content = body_content | replace: alias_to_replace, alias_link_replacement -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%}Process people last, protecting instances that are part of existing links{%- endcomment -%}
{%- for other_person in site.people -%}
  {%- assign name_to_replace = other_person.name -%}
  {%- assign nickname_to_replace = other_person.nickname -%}
  {%- assign display_name = other_person.name -%}
  
  {%- comment -%}Create the replacement link{%- endcomment -%}
  {%- if other_person.hidden -%}
    {%- assign link_replacement = '<span class="hidden-autolink" data-original-name="' | append: display_name | append: '" data-original-url="' | append: other_person.url | append: '">[REDACTED]</span>' -%}
  {%- else -%}
    {%- assign link_replacement = '<a href="' | append: other_person.url | append: '">' | append: other_person.name | append: '</a>' -%}
  {%- endif -%}
  
  {%- comment -%}For nicknames, create a separate replacement that links to the same person{%- endcomment -%}
  {%- if nickname_to_replace and nickname_to_replace != "" -%}
    {%- if other_person.hidden -%}
      {%- assign nickname_link_replacement = '<span class="hidden-autolink" data-original-name="' | append: nickname_to_replace | append: '" data-original-url="' | append: other_person.url | append: '">[REDACTED]</span>' -%}
    {%- else -%}
      {%- assign nickname_link_replacement = '<a href="' | append: other_person.url | append: '">' | append: nickname_to_replace | append: '</a>' -%}
    {%- endif -%}
  {%- endif -%}
  
  {%- comment -%}Replace person names, but protect instances within existing article/video links{%- endcomment -%}
  {%- assign temp_content = body_content -%}
  
  {%- comment -%}Temporarily replace article and video links that contain this person's name or nickname{%- endcomment -%}
  {%- assign protected_links = "" | split: "" -%}
  {%- assign link_counter = 0 -%}
  
  {%- for article in site.articles -%}
    {%- assign should_protect = false -%}
    {%- if article.title contains name_to_replace -%}
      {%- assign should_protect = true -%}
    {%- endif -%}
    {%- if nickname_to_replace and nickname_to_replace != "" and article.title contains nickname_to_replace -%}
      {%- assign should_protect = true -%}
    {%- endif -%}
    {%- if should_protect -%}
      {%- assign article_link_pattern = '<a href="' | append: article.url | append: '">' | append: article.title | append: '</a>' -%}
      {%- if temp_content contains article_link_pattern -%}
        {%- assign placeholder = '___PROTECTED_LINK_' | append: link_counter | append: '___' -%}
        {%- assign temp_content = temp_content | replace_first: article_link_pattern, placeholder -%}
        {%- assign protected_pair = placeholder | append: '|||' | append: article_link_pattern -%}
        {%- assign protected_links = protected_links | push: protected_pair -%}
        {%- assign link_counter = link_counter | plus: 1 -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  
  {%- for video in site.videos -%}
    {%- assign should_protect = false -%}
    {%- if video.title contains name_to_replace -%}
      {%- assign should_protect = true -%}
    {%- endif -%}
    {%- if nickname_to_replace and nickname_to_replace != "" and video.title contains nickname_to_replace -%}
      {%- assign should_protect = true -%}
    {%- endif -%}
    {%- if should_protect -%}
      {%- assign video_link_pattern = '<a href="' | append: video.url | append: '">' | append: video.title | append: '</a>' -%}
      {%- if temp_content contains video_link_pattern -%}
        {%- assign placeholder = '___PROTECTED_LINK_' | append: link_counter | append: '___' -%}
        {%- assign temp_content = temp_content | replace_first: video_link_pattern, placeholder -%}
        {%- assign protected_pair = placeholder | append: '|||' | append: video_link_pattern -%}
        {%- assign protected_links = protected_links | push: protected_pair -%}
        {%- assign link_counter = link_counter | plus: 1 -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  
  {%- comment -%}Now replace the person name in the remaining content{%- endcomment -%}
  {%- assign temp_content = temp_content | replace: name_to_replace, link_replacement -%}
  
  {%- comment -%}Also replace the nickname if it exists{%- endcomment -%}
  {%- if nickname_to_replace and nickname_to_replace != "" -%}
    {%- assign temp_content = temp_content | replace: nickname_to_replace, nickname_link_replacement -%}
  {%- endif -%}
  
  {%- comment -%}Restore the protected links{%- endcomment -%}
  {%- for pair in protected_links -%}
    {%- assign parts = pair | split: '|||' -%}
    {%- assign placeholder = parts[0] -%}
    {%- assign original_link = parts[1] -%}
    {%- assign temp_content = temp_content | replace: placeholder, original_link -%}
  {%- endfor -%}
  
  {%- assign body_content = temp_content -%}
{%- endfor -%}

{%- comment -%}Restore protected attributes (from early protection){%- endcomment -%}
{%- for pair in protected_attributes -%}
  {%- assign parts = pair | split: '|||' -%}
  {%- assign placeholder = parts[0] -%}
  {%- assign original_attr = parts[1] -%}
  {%- assign body_content = body_content | replace: placeholder, original_attr -%}
{%- endfor -%}

{%- comment -%}Restore protected span markers{%- endcomment -%}
{%- for pair in protected_spans -%}
  {%- assign parts = pair | split: '|||' -%}
  {%- assign placeholder = parts[0] -%}
  {%- assign original_content = parts[1] -%}
  {%- assign body_content = body_content | replace: placeholder, original_content -%}
{%- endfor -%}

{{ body_content }}
