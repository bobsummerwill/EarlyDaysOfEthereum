{% comment %}
Back-links Generator
====================
Searches all collections (articles, videos, people) to find pages that link to the current page.
Articles and videos are intermixed chronologically, followed by people.

Usage: {% include back-links.html %}
Expects page.url to be set (automatically available in layouts)
{% endcomment %}

{% assign current_url = page.url %}
{% assign current_title = page.title %}
{% assign current_name = page.name %}
{% assign current_alias = page.alias %}
{% assign content_backlinks = "" | split: "" %}
{% assign people_backlinks = "" | split: "" %}

{% comment %}
Search through all articles for references to current page
{% endcomment %}
{% for article in site.articles %}
  {% if article.url != current_url and article.hidden != true and article.hidden != 'true' %}
    {% comment %}Check if article content or title links to current page{% endcomment %}
    {% assign content_with_fm = article.content | append: article.title | append: article.description %}
    {% assign found_match = false %}
    {% if content_with_fm contains current_url %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_title and current_title != "" and content_with_fm contains current_title %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_name and current_name != "" and content_with_fm contains current_name %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_alias and current_alias != "" and content_with_fm contains current_alias %}
      {% assign found_match = true %}
    {% endif %}
    {% if found_match %}
      {% assign content_backlinks = content_backlinks | push: article %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
Search through all videos for references to current page
{% endcomment %}
{% for video in site.videos %}
  {% if video.url != current_url %}
    {% comment %}Check video content, hosts, guests{% endcomment %}
    {% assign video_content = video.content | append: video.title | append: video.description %}
    {% if video.hosts %}
      {% for host in video.hosts %}
        {% assign video_content = video_content | append: " " | append: host %}
      {% endfor %}
    {% endif %}
    {% if video.guests %}
      {% for guest in video.guests %}
        {% assign video_content = video_content | append: " " | append: guest %}
      {% endfor %}
    {% endif %}
    {% assign found_match = false %}
    {% if video_content contains current_url %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_title and current_title != "" and video_content contains current_title %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_name and current_name != "" and video_content contains current_name %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_alias and current_alias != "" and video_content contains current_alias %}
      {% assign found_match = true %}
    {% endif %}
    {% if found_match %}
      {% assign content_backlinks = content_backlinks | push: video %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
Search through all people for references to current page
{% endcomment %}
{% for person in site.people %}
  {% if person.url != current_url and person.hidden != true and person.hidden != 'true' %}
    {% comment %}Check person content and description{% endcomment %}
    {% assign person_content = person.content | append: person.description | append: person.name %}
    {% assign found_match = false %}
    {% if person_content contains current_url %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_title and current_title != "" and person_content contains current_title %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_name and current_name != "" and person_content contains current_name %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_alias and current_alias != "" and person_content contains current_alias %}
      {% assign found_match = true %}
    {% endif %}
    {% if found_match %}
      {% assign people_backlinks = people_backlinks | push: person %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
Sort content (articles and videos) chronologically by date
{% endcomment %}
{% assign sorted_content = content_backlinks | sort: "date" %}

{% comment %}
Phase 2: Auto-link reciprocal back-links
Find content that the current page would auto-link to, and add those as reciprocal back-links
{% endcomment %}
{% assign current_content = page.content | append: page.title | append: page.description %}

{% comment %}
Find people that the current page would auto-link to
{% endcomment %}
{% for person in site.people %}
  {% if person.url != current_url and person.hidden != true and person.hidden != 'true' %}
    {% comment %}Check if current page content contains this person's name (would create auto-link){% endcomment %}
    {% if person.name and person.name != "" and current_content contains person.name %}
      {% comment %}Add this person as a reciprocal back-link{% endcomment %}
      {% assign already_exists = false %}
      {% for existing in people_backlinks %}
        {% if existing.url == person.url %}
          {% assign already_exists = true %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% unless already_exists %}
        {% assign people_backlinks = people_backlinks | push: person %}
      {% endunless %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
Find articles that the current page would auto-link to
{% endcomment %}
{% assign autolink_backlinks = "" | split: "" %}
{% for article in site.articles %}
  {% if article.url != current_url and article.hidden != true and article.hidden != 'true' %}
    {% assign would_be_linked = false %}
    
    {% comment %}Check if current page would auto-link to this article by title{% endcomment %}
    {% if article.title and article.title != "" and current_content contains article.title %}
      {% assign would_be_linked = true %}
    {% endif %}
    
    {% comment %}Check if current page would auto-link to this article by alias{% endcomment %}
    {% if article.alias and article.alias != "" and current_content contains article.alias %}
      {% assign would_be_linked = true %}
    {% endif %}
    
    {% if would_be_linked %}
      {% comment %}Check if this article isn't already in the backlinks{% endcomment %}
      {% assign already_exists = false %}
      {% for existing in content_backlinks %}
        {% if existing.url == article.url %}
          {% assign already_exists = true %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% unless already_exists %}
        {% assign autolink_backlinks = autolink_backlinks | push: article %}
      {% endunless %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
Find videos that the current page would auto-link to
{% endcomment %}
{% for video in site.videos %}
  {% if video.url != current_url %}
    {% comment %}Check if current page would auto-link to this video by title{% endcomment %}
    {% if video.title and video.title != "" and current_content contains video.title %}
      {% comment %}Check if this video isn't already in the backlinks{% endcomment %}
      {% assign already_exists = false %}
      {% for existing in content_backlinks %}
        {% if existing.url == video.url %}
          {% assign already_exists = true %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% for existing in autolink_backlinks %}
        {% if existing.url == video.url %}
          {% assign already_exists = true %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% unless already_exists %}
        {% assign autolink_backlinks = autolink_backlinks | push: video %}
      {% endunless %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
Merge auto-link back-links with content back-links and sort chronologically
{% endcomment %}
{% assign all_content_backlinks = content_backlinks | concat: autolink_backlinks %}
{% assign sorted_content = all_content_backlinks | sort: "date" %}

{% comment %}
Display back-links section if any were found
{% endcomment %}
{% assign total_backlinks = all_content_backlinks.size | plus: people_backlinks.size %}
{% if total_backlinks > 0 %}
<div class="back-links-section">
  <h2>Back-links</h2>
  <p class="back-links-description">Other pages that reference this:</p>
  <ul class="back-links-list">
    {% comment %}First display articles and videos in chronological order{% endcomment %}
    {% for backlink in sorted_content %}
    <li>
      <a href="{{ backlink.url }}">{{ backlink.title | default: backlink.name }}</a>
      {% if backlink.collection %}
        <span class="back-link-type">({{ backlink.collection | slice: 0 | upcase }}{{ backlink.collection | slice: 1, 20 }})</span>
      {% endif %}
    </li>
    {% endfor %}
    
    {% comment %}Then display people alphabetically{% endcomment %}
    {% assign sorted_people = people_backlinks | sort: "name" %}
    {% for backlink in sorted_people %}
    <li>
      <a href="{{ backlink.url }}">{{ backlink.title | default: backlink.name }}</a>
      {% if backlink.collection %}
        <span class="back-link-type">({{ backlink.collection | slice: 0 | upcase }}{{ backlink.collection | slice: 1, 20 }})</span>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
</div>
{% endif %}
