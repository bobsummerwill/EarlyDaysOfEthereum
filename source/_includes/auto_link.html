{%- comment -%}
Auto-link system that creates links for videos, articles, and people names
while avoiding double-linking (replacing text that's already inside links)

This system processes content in four phases:
0. Hidden People Links - Converts explicit links to hidden people into [REDACTED]
1. Videos - Links video titles to their pages
2. Articles - Links article titles to their pages (including embedded content)
3. People - Links person names to their pages, with conflict detection

The people processing phase includes conflict detection to prevent double-linking.
When a person's name appears within an article title that has already been linked,
the person name linking is skipped. For example:
- Article "Taylor Gerring Photos" gets linked first
- When processing people, "Taylor Gerring" is detected as already being
  part of an existing article link, so it's skipped
- This prevents creating nested <a> tags like:
  <a href="/articles/taylor-gerring-photos/"><a href="/people/taylor-gerring/">Taylor Gerring</a> Photos</a>

The system maintains proper priority: Hidden People > Videos > Articles > People
while ensuring clean, valid HTML output.
{%- endcomment -%}

{%- assign body_content = include.content -%}

{%- comment -%}Process hidden people links first - replace explicit links to hidden people with [REDACTED]{%- endcomment -%}
{%- for person in site.people -%}
  {%- if person.hidden -%}
    {%- comment -%}Handle links with various formats - we need to replace the entire <a>...</a> tag{%- endcomment -%}
    {%- assign person_url_pattern = person.url | append: '"' -%}
    {%- assign person_url_pattern_slash = person.url | append: '/"' -%}
    
    {%- comment -%}Split content on opening link tag to find matches{%- endcomment -%}
    {%- assign parts = body_content | split: '<a href="' -%}
    {%- assign new_content = "" -%}
    {%- for part in parts -%}
      {%- if forloop.first -%}
        {%- assign new_content = part -%}
      {%- else -%}
        {%- comment -%}Check if this part starts with the hidden person's URL{%- endcomment -%}
        {%- if part contains person_url_pattern or part contains person_url_pattern_slash -%}
          {%- comment -%}Find the closing tag and replace the link with [REDACTED]{%- endcomment -%}
          {%- assign close_tag_parts = part | split: '</a>' -%}
          {%- if close_tag_parts.size > 1 -%}
            {%- comment -%}Check if this is actually a link to this person{%- endcomment -%}
            {%- assign link_start = close_tag_parts[0] -%}
            {%- if link_start contains person.url -%}
              {%- assign new_content = new_content | append: '[REDACTED]' -%}
              {%- for remaining_part in close_tag_parts offset: 1 -%}
                {%- if forloop.first -%}
                  {%- assign new_content = new_content | append: remaining_part -%}
                {%- else -%}
                  {%- assign new_content = new_content | append: '</a>' | append: remaining_part -%}
                {%- endif -%}
              {%- endfor -%}
            {%- else -%}
              {%- assign new_content = new_content | append: '<a href="' | append: part -%}
            {%- endif -%}
          {%- else -%}
            {%- assign new_content = new_content | append: '<a href="' | append: part -%}
          {%- endif -%}
        {%- else -%}
          {%- assign new_content = new_content | append: '<a href="' | append: part -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign body_content = new_content -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%}Process videos first{%- endcomment -%}
{%- for video in site.videos -%}
  {%- assign title_to_replace = video.title -%}
  {%- assign link_replacement = '<a href=" | append: video.url | append: ">' | append: video.title | append: '</a>' -%}
  {%- assign body_content = body_content | replace: title_to_replace, link_replacement -%}
{%- endfor -%}

{%- comment -%}Process articles second{%- endcomment -%}
{%- for article in site.articles -%}
  {%- assign title_to_replace = article.title -%}
  {%- assign alias_to_replace = article.alias -%}
  {%- if article.embed and article.embed.url -%}
    {%- capture embed_html -%}
      <a href="{{ article.url }}" style="text-decoration: none; color: inherit;">
        {% assign embed_date = article.date | date: "%B %d, %Y" %}
        {% include content-embed.html
          url=article.embed.url
          img=article.embed.img
          site=article.embed.site
          title=article.title
          author=article.author
          date=embed_date
          description=article.description
        %}
      </a>
    {%- endcapture -%}
    {%- assign body_content = body_content | replace: title_to_replace, embed_html -%}
    {%- if alias_to_replace %}
      {%- assign body_content = body_content | replace: alias_to_replace, embed_html -%}
    {%- endif -%}
  {%- else -%}
    {%- assign link_replacement = '<a href=" | append: article.url | append: ">' | append: article.title | append: '</a>' -%}
    {%- assign body_content = body_content | replace: title_to_replace, link_replacement -%}
    {%- if alias_to_replace %}
      {%- assign alias_link_replacement = '<a href=" | append: article.url | append: ">' | append: article.alias | append: '</a>' -%}
      {%- assign body_content = body_content | replace: alias_to_replace, alias_link_replacement -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%}Process people last, protecting instances that are part of existing links{%- endcomment -%}
{%- for other_person in site.people -%}
  {%- assign name_to_replace = other_person.name -%}
  {%- assign display_name = other_person.name -%}
  
  {%- comment -%}Create the replacement link{%- endcomment -%}
  {%- if other_person.hidden -%}
    {%- assign link_replacement = '<span class="hidden-autolink" data-original-name="' | append: display_name | append: '" data-original-url="' | append: other_person.url | append: '">[REDACTED]</span>' -%}
  {%- else -%}
    {%- assign link_replacement = '<a href=" | append: other_person.url | append: ">' | append: other_person.name | append: '</a>' -%}
  {%- endif -%}
  
  {%- comment -%}Replace person names, but protect instances within existing article/video links{%- endcomment -%}
  {%- assign temp_content = body_content -%}
  
  {%- comment -%}First, temporarily replace article and video links that contain this person's name{%- endcomment -%}
  {%- assign protected_links = "" | split: "" -%}
  {%- assign link_counter = 0 -%}
  
  {%- for article in site.articles -%}
    {%- if article.title contains name_to_replace -%}
      {%- assign article_link_pattern = '<a href=" | append: article.url | append: ">' | append: article.title | append: '</a>' -%}
      {%- if temp_content contains article_link_pattern -%}
        {%- assign placeholder = '___PROTECTED_LINK_' | append: link_counter | append: '___' -%}
        {%- assign temp_content = temp_content | replace_first: article_link_pattern, placeholder -%}
        {%- assign protected_pair = placeholder | append: '|||' | append: article_link_pattern -%}
        {%- assign protected_links = protected_links | push: protected_pair -%}
        {%- assign link_counter = link_counter | plus: 1 -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  
  {%- for video in site.videos -%}
    {%- if video.title contains name_to_replace -%}
      {%- assign video_link_pattern = '<a href=" | append: video.url | append: ">' | append: video.title | append: '</a>' -%}
      {%- if temp_content contains video_link_pattern -%}
        {%- assign placeholder = '___PROTECTED_LINK_' | append: link_counter | append: '___' -%}
        {%- assign temp_content = temp_content | replace_first: video_link_pattern, placeholder -%}
        {%- assign protected_pair = placeholder | append: '|||' | append: video_link_pattern -%}
        {%- assign protected_links = protected_links | push: protected_pair -%}
        {%- assign link_counter = link_counter | plus: 1 -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  
  {%- comment -%}Now replace the person name in the remaining content{%- endcomment -%}
  {%- assign temp_content = temp_content | replace: name_to_replace, link_replacement -%}
  
  {%- comment -%}Restore the protected links{%- endcomment -%}
  {%- for pair in protected_links -%}
    {%- assign parts = pair | split: '|||' -%}
    {%- assign placeholder = parts[0] -%}
    {%- assign original_link = parts[1] -%}
    {%- assign temp_content = temp_content | replace: placeholder, original_link -%}
  {%- endfor -%}
  
  {%- assign body_content = temp_content -%}
{%- endfor -%}

{{ body_content }}
